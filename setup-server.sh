#!/bin/bash
set -e

# ============================================================================
# setup-server.sh
# ----------------------------------------------------------------------------
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–†–í–ï–†–ê –î–õ–Ø –ü–ï–†–í–û–ì–û –ó–ê–ü–£–°–ö–ê
# ----------------------------------------------------------------------------
# ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ
#           –Ω–æ–≤–æ–≥–æ/—á–∏—Å—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
#
# –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:
#   ‚úÖ –°–µ—Ç—å todo-network –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞
#   ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä mysql-db –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ —Å–µ—Ç–∏
#   ‚úÖ –î–∞–Ω–Ω—ã–µ –ë–î –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ volume (–Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
#
# –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–ø–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —á–µ—Ä–µ–∑ GitHub Actions
# –ø—Ä–∏ –ø—É—à–µ –∫–æ–¥–∞ –≤ –≤–µ—Ç–∫—É master ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –ù–ï –ù–£–ñ–ù–û!
# ============================================================================

echo "üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è todo-app..."

# 1. –°–æ–∑–¥–∞—ë–º —Å–µ—Ç—å (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
echo "1. –°–æ–∑–¥–∞—ë–º —Å–µ—Ç—å todo-network..."
docker network create todo-network 2>/dev/null && \
  echo "   ‚úÖ –°–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∞" || \
  echo "   ‚ÑπÔ∏è  –°–µ—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º –ë–î —á–µ—Ä–µ–∑ docker-compose
echo "2. –ó–∞–ø—É—Å–∫–∞–µ–º MySQL —á–µ—Ä–µ–∑ docker-compose..."
docker-compose up -d mysql-db

# 3. –ñ–¥—ë–º, –ø–æ–∫–∞ –ë–î —Å—Ç–∞–Ω–µ—Ç –≥–æ—Ç–æ–≤–æ–π
echo "3. –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î (30 —Å–µ–∫—É–Ω–¥)..."
for i in {1..30}; do
  sleep 1
  printf "."
done
echo ""
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ë–î
if docker inspect mysql-db --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
  echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
  echo ""
  echo "üìã –î–∞–ª–µ–µ:"
  echo "   1. –ó–∞–ø—É—à—å—Ç–µ –∫–æ–¥ –≤ –≤–µ—Ç–∫—É master:"
  echo "      git push origin master"
  echo "   2. –ü–∞–π–ø–ª–∞–π–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:"
  echo "      ‚Ä¢ —Å–æ–±–µ—Ä—ë—Ç –æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
  echo "      ‚Ä¢ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –≤ Docker Hub"
  echo "      ‚Ä¢ —Ä–∞–∑–≤–µ—Ä–Ω—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä todo-app –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
  echo ""
  echo "üí° –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!"
else
  echo "‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞ (–æ–∂–∏–¥–∞–π—Ç–µ –µ—â—ë 1-2 –º–∏–Ω—É—Ç—ã)"
  echo "   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: docker inspect mysql-db --format='{{.State.Health.Status}}'"
fi