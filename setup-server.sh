#!/bin/bash
set -e

# ============================================================================
# setup-server.sh
# ----------------------------------------------------------------------------
# –ü–û–õ–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–†–í–ï–†–ê –î–õ–Ø TODO-APP
# ----------------------------------------------------------------------------
# ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫–∞—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –Ω–∞ —á–∏—Å—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ (Ubuntu/Debian)
#           –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root (–∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root)
#
# –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:
#   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫—É —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
#   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫—É Docker –∏ Docker Compose
#   ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ todo-network
#   ‚úÖ –ó–∞–ø—É—Å–∫ MySQL —á–µ—Ä–µ–∑ docker-compose
#   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î
#
# –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—É—à–∏—Ç–µ –∫–æ–¥ –≤ master, –¥–µ–ø–ª–æ–π –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º.
# ============================================================================

if [[ $EUID -ne 0 ]]; then
  echo "‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root!"
  echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: sudo ./setup-server.sh"
  exit 1
fi

echo "=========================================="
echo "üöÄ –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ todo-app"
echo "=========================================="
echo ""

# ============================================================================
# –®–ê–ì 1: –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
# ============================================================================
echo "üîß –®–ê–ì 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
apt-get update > /dev/null 2>&1
DEBIAN_FRONTEND=noninteractive apt-get install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release \
  git > /dev/null 2>&1

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ HTTPS-–¥–æ—Å—Ç—É–ø–∞
update-ca-certificates --fresh > /dev/null 2>&1

echo "   ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# ============================================================================
# –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
# ============================================================================
echo "üê≥ –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."

if ! command -v docker &> /dev/null; then
  # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π GPG-–∫–ª—é—á Docker
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
    gpg --dearmor -o /etc/apt/keyrings/docker.gpg > /dev/null 2>&1
  chmod a+r /etc/apt/keyrings/docker.gpg

  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
    https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
    tee /etc/apt/sources.list.d/docker.list > /dev/null 2>&1

  apt-get update > /dev/null 2>&1
  DEBIAN_FRONTEND=noninteractive apt-get install -y docker-ce docker-ce-cli containerd.io > /dev/null 2>&1
  echo "   ‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
  echo "   ‚ÑπÔ∏è  Docker —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi

# ============================================================================
# –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
# ============================================================================
echo "üì¶ –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose..."

if ! command -v docker-compose &> /dev/null; then
  # –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Docker Compose Plugin
  DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | \
    grep '"tag_name"' | cut -d'"' -f4)
  curl -SL "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose > /dev/null 2>&1
  chmod +x /usr/local/bin/docker-compose
  echo "   ‚úÖ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–≤–µ—Ä—Å–∏—è ${DOCKER_COMPOSE_VERSION:1})"
else
  echo "   ‚ÑπÔ∏è  Docker Compose —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi

# ============================================================================
# –®–ê–ì 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏
# ============================================================================
echo "üï∏Ô∏è  –®–ê–ì 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ todo-network..."

if docker network inspect todo-network > /dev/null 2>&1; then
  echo "   ‚ÑπÔ∏è  –°–µ—Ç—å todo-network —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
else
  docker network create todo-network > /dev/null 2>&1
  echo "   ‚úÖ –°–µ—Ç—å todo-network —Å–æ–∑–¥–∞–Ω–∞"
fi

# ============================================================================
# –®–ê–ì 5: –ó–∞–ø—É—Å–∫ –ë–î —á–µ—Ä–µ–∑ docker-compose
# ============================================================================
echo "üóÉÔ∏è  –®–ê–ì 5: –ó–∞–ø—É—Å–∫ MySQL —á–µ—Ä–µ–∑ docker-compose..."

if [ ! -f "docker-compose.yml" ]; then
  echo "   ‚ö†Ô∏è  –§–∞–π–ª docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
  echo "   üí° –°–æ–≤–µ—Ç: –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞:"
  echo "      git clone https://github.com/mngerasimenko/–≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.git"
  echo "      cd –≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
  exit 1
fi

docker-compose up -d mysql-db > /dev/null 2>&1
echo "   ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä mysql-db –∑–∞–ø—É—â–µ–Ω"

# ============================================================================
# –®–ê–ì 6: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î
# ============================================================================
echo "‚è≥ –®–ê–ì 6: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–º–∞–∫—Å. 60 —Å–µ–∫—É–Ω–¥)..."

timeout=60
count=0
until docker inspect mysql-db --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy" || [ $count -ge $timeout ]; do
  sleep 1
  count=$((count + 1))
  printf "."
done
echo ""

if [ $count -lt $timeout ]; then
  echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
  echo ""
  echo "=========================================="
  echo "üéâ –°–ï–†–í–ï–† –£–°–ü–ï–®–ù–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù!"
  echo "=========================================="
  echo ""
  echo "üìã –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:"
  echo "   1. –ó–∞–ø—É—à—å—Ç–µ –∫–æ–¥ –≤ –≤–µ—Ç–∫—É master:"
  echo "      git push origin master"
  echo ""
  echo "   2. –ü–∞–π–ø–ª–∞–π–Ω GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:"
  echo "      ‚Ä¢ —Å–æ–±–µ—Ä—ë—Ç –æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
  echo "      ‚Ä¢ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –≤ Docker Hub"
  echo "      ‚Ä¢ —Ä–∞–∑–≤–µ—Ä–Ω—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä todo-app –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
  echo ""
  echo "üí° –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!"
  echo "   (–î–∞–Ω–Ω—ã–µ –ë–î —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ volume –∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö)"
  echo ""
else
  echo "‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—Ç–∞–ª–∞ –∑–¥–æ—Ä–æ–≤–æ–π –∑–∞ 60 —Å–µ–∫—É–Ω–¥"
  echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs mysql-db"
  exit 1
fi